pipeline {
    agent { label "docker-alpine-jdk21" }

    stages {

        stage('Install Terraform if missing') {
            steps {
                script {
                    sh '''
                        set -e
                        if ! command -v terraform &> /dev/null; then
                            echo "Terraform not found. Installing version 1.12.1..."
                            
                            # Try using apt-get (Debian/Ubuntu)
                            if command -v apt-get &> /dev/null; then
                                sudo apt-get update
                                sudo apt-get install -y curl unzip
                            # Try using apk (Alpine)
                            elif command -v apk &> /dev/null; then
                                apk add --no-cache curl unzip
                            # Try using yum (CentOS/RHEL)
                            elif command -v yum &> /dev/null; then
                                yum install -y curl unzip
                            # Try using dnf (Fedora/newer RHEL)
                            elif command -v dnf &> /dev/null; then
                                dnf install -y curl unzip
                            else
                                echo "No supported package manager found. Installing dependencies might fail."
                            fi
                            
                            # Create directory for terraform if not exists
                            mkdir -p /tmp/terraform_install
                            cd /tmp/terraform_install
                            
                            # Download and install Terraform
                            curl -s -o terraform.zip https://releases.hashicorp.com/terraform/1.12.1/terraform_1.12.1_linux_amd64.zip
                            unzip -o terraform.zip
                            mkdir -p ~/bin
                            mv terraform ~/bin/
                            export PATH=$PATH:~/bin
                            
                            # Verify installation
                            echo "Terraform installed at $(which terraform), version: $(terraform --version)"
                        else
                            echo "Terraform is already installed: $(terraform --version)"
                        fi
                        
                        # Ensure terraform is in PATH for subsequent stages
                        export PATH=$PATH:~/bin
                    '''
                }
            }
        }

        stage('Syntax check') {
            steps {
                echo "Checking syntax"
                sh "terraform init"
            }
        }
        
        stage('Syntax validation') {
            steps {  
                echo "Validating Syntax"
                sh "terraform validate"
            }    
        }

        stage('Approval') {
            steps {
            input message: "Are you sure you want to deploy the infrastructure?"
            }
        }

        stage("Deployment") {
            steps {

            echo "Deploying your infrastructure..."
            sh "terraform apply -auto-approve"
            }
    }   } 
}    